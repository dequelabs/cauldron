version: 2

defaults: &defaults
  docker:
    - image: circleci/node:10
  working_directory: ~/cauldron

jobs:
  react:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
        keys:
          - v1-react-yarn-{{ checksum "packages/react/yarn-lock.json" }}
          - v1-react-yarn-
      - run: NODE_ENV=production yarn run build --prefix=packages/react
      - run: npm run --prefix=packages/react test
      - run: npm run --prefix=packages/react test:ts
  styles:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
        keys:
          - v1-styles-yarn-{{ checksum "packages/styles/yarn-lock.json" }}
          - v1-styles-yarn-
      - run: npx lerna bootstrap
      - run: NODE_ENV=production yarn run build --prefix=packages/styles
  dependencies:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-yarn-cache-{{ checksum "yarn.lock" }}
            - v1-yarn-cache-
      - restore_cache:
          keys:
            - v1-react-yarn-{{ checksum "packages/react/yarn-lock.json" }}
            - v1-react-yarn-
      - restore_cache:
          keys:
            - v1-styles-yarn-{{ checksum "packages/styles/yarn-lock.json" }}
            - v1-styles-yarn-
      - run: yarn
      - save_cache:
          key: v1-yarn-cache-{{ checksum "yarn.lock" }}
          paths:
            - node_modules
      - save_cache:
          key: v1-react-yarn-{{ checksum "packages/react/yarn-lock.json" }}
      - save_cache:
          key: v1-styles-yarn-{{ checksum "packages/styles/yarn-lock.json" }}
  checks:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          key: v1-yarn-cache-{{ checksum "yarn.lock" }}
      - run: yarn lint

workflows:
  version: 2
  build:
    jobs:
      - dependencies
      - checks:
          requires:
            - dependencies
      - react:
          requires:
            - dependencies
            - checks
      - styles:
          requires:
            - dependencies
            - checks
